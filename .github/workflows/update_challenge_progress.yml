name: Update Challenge Progress

on:
  pull_request:
    types:
      - closed
  workflow_dispatch:

jobs:
  update_progress:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Configure Github User & Sync with main branch
        run: |
          git config --global user.name "${{ secrets.GIT_USER_NAME }}"
          git config --global user.email "${{ secrets.GIT_USER_EMAIL }}"
          git pull origin main --rebase
        
      - name: Run extract_pr_data.py
        working-directory: _MonthlyChallenges
        run: python extract_pr_data.py

      - name: Run update_scoreboard.py
        working-directory: _MonthlyChallenges
        run: python update_scoreboard.py

      - name: Run update_dashboard.py
        working-directory: _MonthlyChallenges
        run: python update_dashboard.py
          git push https://x-access-token:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/AlgorithmStudy-Allumbus/codingtest_algorithm_study.git ${{ github.head_ref }}

      - name: Commit updated files
        run: |
          cd _MonthlyChallenges
          git add scoreboard.json DASHBOARD.md HISTORY.md
          git commit -m "Update challenge progress dashboard" || echo "No changes to commit"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "Update challenge progress dashboard"
          title: "ìë™ PR: ì±Œë¦°ì§€ ì§„í–‰ ìƒí™© ê°±ì‹ "
          body: |
            This pull request was automatically generated by the workflow.
          branch: auto/update-dashboard
          base: main
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}


      - name: Post PR Comment with progress
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            // DASHBOARD.md íŒŒì¼ì—ì„œ ë‚´ìš© ì½ì–´ì˜¤ê¸° (working-directoryì— ë”°ë¼ ê²½ë¡œ ì¡°ì •)
            const dashboard = fs.readFileSync('_MonthlyChallenges/DASHBOARD.md', 'utf8');
            // PR ì´ë²¤íŠ¸ì—ì„œ PR ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
            const prNumber = context.payload.pull_request.number;
            // GitHub REST APIë¥¼ í†µí•´ ì½”ë©˜íŠ¸ ìƒì„±
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: dashboard
            });

  # notify_discord:
  #   needs: update_progress
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout Repository
  #       uses: actions/checkout@v3
  #       with:
  #         fetch-depth: 0
  #         ref: main

  #     - name: Send Dashboard to Discord
  #       working-directory: _MonthlyChallenges
  #       run: |
  #         # DASHBOARD.md íŒŒì¼ì„ ì•ˆì „í•˜ê²Œ JSON ë¬¸ìì—´ë¡œ ì´ìŠ¤ì¼€ì´í”„
  #         DASHBOARD_CONTENT=$(jq -R -s '.' DASHBOARD.md)
  #         echo "Dashboard content: $DASHBOARD_CONTENT"
          
  #         # Discord ì„ë² ë“œ ë©”ì‹œì§€ JSON ìƒì„±
  #         EMBED_JSON=$(cat <<EOF
  #         {
  #             "content": "",
  #             "embeds": [
  #               {
  #                 "author": {
  #                   "name": "AllumbusğŸ”¥",
  #                   "url": "https://github.com/AlgorithmStudy-Allumbus",
  #                   "icon_url": "https://imgur.com/kKJg6v3.jpg"
  #                 },
  #                 "title": "**ğŸ“Š ì±Œë¦°ì§€ ì§„í–‰ ìƒí™©**",
  #                 "url": "https://github.com/AlgorithmStudy-Allumbus/codingtest_algorithm_study/blob/main/_MonthlyChallenges/DASHBOARD.md",
  #                 "description": ${DASHBOARD_CONTENT},
  #                 "color": 15258703,
  #                 "footer": {
  #                   "text": "Updated on $(date '+%Y-%m-%d %H:%M:%S')"
  #                 }
  #               }
  #             ]
  #         }
  #         EOF
  #         )
  #         echo "Embed JSON: $EMBED_JSON"
          
  #         # Discord ì›¹í›… í˜¸ì¶œ (ë””ë²„ê·¸ë¥¼ ìœ„í•´ -v ì˜µì…˜ ì‚¬ìš©)
  #         curl -v -H "Content-Type: application/json" \
  #             -X POST \
  #             -d "$EMBED_JSON" \
  #             "${{ secrets.DISCORD_WEBHOOK_URL }}"
